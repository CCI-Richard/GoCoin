<html>
 <head>
<script src="http://ajax.googleapis.com/ajax/libs/dojo/1.7.1/dojo/dojo.js" data-dojo-config="async: true"></script>
<script type="text/javascript" src="gwt-oauth2.js"></script>
<style type="text/css">

.dijitToasterContent {
	padding:1em;
	padding-top:0.25em;
	background:#73c74a;
}
.dijitToasterMessage{ 
	color:#fff;
}
.dijitToasterWarning{ }
.dijitToasterError,
.dijitToasterFatal{
	font-weight:bold;
	color:#fff;
}
.dijitToasterWarning .dijitToasterContent{
	background:#d4d943;
} 
.dijitToasterError .dijitToasterContent{
	background:#c46600;
}
 
.dijitToasterClip {
	position: absolute;
	z-index: 5000;
	overflow: hidden;
}
.dijitToasterContainer {
	display: block;
	position: absolute;
	width: 17.5em;
	margin: 0px;
	font:0.75em;
}
</style>
</head>
 <body>
  <script type="text/javascript">

  /* Constants */
  	var crossDomainProxy = 'http://localhost:8082/'; // cross domain proxy|| todo: hardcode this so it can't be hacked
	var goCoinWalletFilename = 'GoCoin Wallet File';
  	
  	
  /* Variables */
	var oAuthToken = '';
	var toaster = null; 
	var walletDocID = null;		// user's wallet document id (google doc id)
	
	
	/* Call a HTTP GET Google API using oAuth2 authentication.
	 * 	gaurl 		- API url to call
	 *	params 		- js map of name value pairs to send as params
	 *	callBack	- function to call with data once the api returns
	 *	return		- object translated from json response
	 */	
	function google_api(gaurl, params, json, callBack) {

  		dojo.xhrGet({
   			url: crossDomainProxy,
			handleAs: (json ? "json" : "text"),
			load: callBack,
			preventCache: true,
			content: params,
			headers: {
				"X-Apiurl": gaurl,
				"Authorization": "OAuth " + oAuthToken,				
				"X-Requested-With": null
			},				
			error: function(error){
  				alert("An unexpected error occurred: " + error);
			}
  		});			
	}


	/* Call a Google API using oAuth2 authentication for POSTing
	 * 	gaurl 		- API url to call
	 *	payload 	- payload data for the call
	 *	callBack	- function to call with data once the api returns
	 *  contentType	- "application/atom+xml" for example
	 *	return		- object translated from json response
	 */	
	function google_api_post(gaurl, payload, contentType, additionalHeaders, callBack) {
		
		headers = {
				"X-Apiurl": gaurl,
				"Authorization": "OAuth " + oAuthToken,
				"Content-Type": contentType,
				"X-Requested-With": null
		}
		
		for (var h in additionalHeaders) {
			headers[h] = additionalHeaders[h];
		}
		
		dojo.xhrPost({
			url: crossDomainProxy,
			handleAs: "text",
			load: callBack,
			preventCache: true,
			rawBody: payload + "",
			headers: headers,				
			error: function(error){
				alert("An unexpected error occurred: " + error);
			}	
  		});
  			
	}
	
	

	/* Call a Google API using oAuth2 authentication for PUTing
	 * 	gaurl 		- API url to call
	 *	payload 	- payload data for the call
	 *  upToByte	- starting byte in overall file that this payload represents
	 *  contentTotalLength	- total file length
	 *	callBack	- function to call with data once the api returns
	 *  contentType	- "application/atom+xml" for example
	 *	return		- object translated from json response
	 */	
	function google_api_put(gaurl, payload, uptoByte, contentType, contentTotalLength, additionalHeaders, callBack) {
		
		headers = {
				"X-Apiurl": gaurl,
				"Authorization": "OAuth " + oAuthToken,
				"Content-Type": contentType,
				"Content-Range": "" + uptoByte + "-" + (uptoByte + payload.length) + "/" + contentTotalLength,
				"X-Requested-With": null
		}
		
		for (var h in additionalHeaders) {
			headers[h] = additionalHeaders[h];
		}
		
		dojo.xhrPut({
			url: crossDomainProxy,
			handleAs: "text",
			load: callBack,
			preventCache: true,
			rawBody: payload,
			headers: headers,				
			error: function(error){
				alert("An unexpected error occurred: " + error);
			}	
  		});
  			
	}
	
		
		
	/* Debug Print an Object as JSON to the console.
	 *	o		- object to print
	 */	 
	function d(o) {
		console.log(dojo.toJson(o, true));
	}
	
	
	/* Notify the user of some event or occurance 
	 *	message		- the message to display
	 *	type		- message, warning, error, fatal
	 *	dur			- duration of msg (ms)
	 */
	function toast(message, mtype, dur){
		if (toaster == null) toaster = new dojox.widget.Toaster();
		toaster.positionDirection = 'br-up';
	
		toaster.setContent(message, mtype, dur);
		toaster.show();
	}

	
	/* Returns the user's Wallet Document ID
	 */
	function getWalletDocID() {
		google_api('https://spreadsheets.google.com/feeds/spreadsheets/private/full?v=3&alt=json', {}, true, function(data){
			var docCount = data.feed.openSearch$totalResults;
			if (docCount == 0)	return _createWalletDoc();
			
			var entries = data.feed.entry;
			var i = entries.length;
			while (i--) {
				d(entries[i].title);
				if (entries[i].title.$t == goCoinWalletFilename) {
					walletDocID = entries[i].id.$t;
					wallet_init();
					d(entries[i]);
					return;
				}
			}
			
			return _createWalletDoc();
		});		
	}
	
	/* Creates and returns the Wallet spreadsheet Document ID
	 * ONLY TO BE INVOKED WHEN NO WALLET EXISTS *
	 */
	function _createWalletDoc() {
		d('Creating wallet');
		//Get the resumable-create-media link (this should not be hardcoded, hence the extra request
		google_api('https://docs.google.com/feeds/default/private/full?v=3&alt=json', {}, true, function(data){
			var rcm_link = null;
			
			var links = data.feed.link;
			var i = links.length;
			while (i--) {
				if (links[i].rel == "http://schemas.google.com/g/2005#resumable-create-media") {
					rcm_link = links[i].href;
					break;	
				}	
			}
			
			d('rcm_link: ' + rcm_link);
			
			var message = "WARNING!!! DO NOT TOUCH THIS FILE. YOU WILL LOSE YOUR BITCOINS IF YOU DO!";

  			google_api_post(rcm_link, '<?xml version="1.0" encoding="UTF-8"?>\
<entry xmlns="http://www.w3.org/2005/Atom" xmlns:docs="http://schemas.google.com/docs/2007">\
<category scheme="http://schemas.google.com/g/2005#kind" term="http://schemas.google.com/docs/2007#spreadsheet"/>\
<title>' + goCoinWalletFilename + '</title></entry>', "application/atom+xml", {"X-Upload-Content-Length": "" + (message.length), "X-Upload-Content-Type": "text/csv"}, function(data) {
			
				console.log("data: '" + data + "'");
				google_api_put(data, message, 0, "text/csv", message.length, {}, function(data) {
					console.log("data: '" + data + "'");
					getWalletDocID();
				});
	
	  			
  			});
					
		});
	}
	
	/* Init the GoCoin application with an oAuth 2.0 token
	 *	token		- oAuth 2.0 token from Google authorizing spreadsheet use
	 */
	function gocoin_init(token) {
		oAuthToken = token;
		getWalletDocID();
	}
	
	/* Init the GoCoin wallet 
	 * This init is called after the wallet file has been found/created
	 */
	function wallet_init() {
		d(walletDocID);
		
	}


   require(["dojo/dom", "dojo/_base/xhr", "dojox/widget/Toaster",  "dojo/domReady!"], function(dom){
   	(function() {
	 var GOOGLE_AUTH_URL = "https://accounts.google.com/o/oauth2/auth";
	 var GOOGLE_CLIENT_ID = "988326713233-10of7p94959dk7knfmgnu7lj20rels21.apps.googleusercontent.com";
	 var GOOGLE_SCOPE = "https://spreadsheets.google.com/feeds/ https://docs.google.com/feeds/";

	 var button = document.createElement("button");
	 button.innerHTML = "Authenticate with Google";
	 button.onclick = function() {
	   var req = {
		 "authUrl" : GOOGLE_AUTH_URL,
		 "clientId" : GOOGLE_CLIENT_ID,
		 "scopes" : [ GOOGLE_SCOPE ],
	   };
	   oauth2.login(req, function(token) {

		gocoin_init(token);
	   }, function(error) {
		 alert("Error:\n" + error);
	   });
	 };
	 document.body.appendChild(button);})();
	 });
  </script>
<div data-dojo-type="dojox.widget.Toaster" data-dojo-props="positionDirection:'br-left'"
	 id="first_toaster">
</div>

<div id="ToasterPane"></div>
  </body>

</html>
